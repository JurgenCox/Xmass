<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mystyle.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.dataTables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/select.dataTables.min.css') }}">
<style>




</style>

    <script src="{{ url_for('static', filename='js/jquery.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/jquery.dataTables.js') }}" type="text/javascript" charset="utf8"  ></script>


</head>
<body></body>
<div class="divheader">
<h1>XMASS</h1>
<h2>Train your own models for MSMS and RT prediction</h2>
</div>
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Train')" id="defaultOpen">Training</button>
  <button class="tablinks" onclick="openTab(event, 'Evaluate')">Evaluation</button>
  <button class="tablinks" onclick="openTab(event, 'Services')">Test services</button>
</div>

<div id="Train" class="tabcontent">
        <form id ="search_folder"><br>
            <table>
                <tr>
                    <td><label for="pathroot">Location msms.txt files:</label></td>
                    <td><input type="text" id="pathroot" name="pathroot" style="width: 400px;"><br></td>
                </tr>
                <tr>
                    <td><label for="andromedascore">Andromeda score threshold:</label></td>
                    <td><input type="text" id="andromedascore" name="andromedascore" style="width: 50px;"></td>
                </tr>
                <tr>
                    <td><button type="submit" class="button_submit">Search files</button></td>
                </tr>

            </table>
                <div id="loadingDiv_search_files">
                    <img src="{{url_for('static', filename='images/ajax-loader.gif')}}">
                </div>
        </form>

        <div id="trainingDiv">
            <table id="example" class="display" >
              <thead>
                <tr>
                <th>id</th><th>Fragmentation</th><th>Charge</th><th># Unique peptides</th>
                </tr>
              </thead>
            </table>
            Models:
            <div id="checkboxes">
                <input type="checkbox" id="cb_msms" name="Msms Specta" checked>
                Msms Specta
                <br>
                <input type="checkbox" id="cb_rt" name="Retention Time">
                Retention Time
            </div>
        <br>
        <label for="pathroot">REST API name:</label>
        <input type="text" id="rest_api_name" name="pathroot" style="width: 300px;">
        <button onclick="return train()" class="button_submit">Train Models</button>
            <div id="loadingDiv_train">
                    <img src="{{url_for('static', filename='images/ajax-loader.gif')}}">
            </div>
        </div>
</div>
<div id="Evaluate" class="tabcontent">
    <br>
    <form id="form_list_models">
        <label for="modelsDropdown">Models</label>
        <select id="modelsDropdown" name="modelsDropdown"></select>
    </form>
    <br>
    <a href="#"><img id ="img_rt" name="img_rt" style="width:600px;height:400px;"></a>
    <a href="#"><img id ="img_msms" name="img_msms" style="width:600px;height:400px;"></a>
    <div id="chart_rt_realVSpred"></div>
</div>

<div id="Services" class="tabcontent">
<br>
            <form id="form_test_service">
            <label for="rest_api_name_test">REST API URL:</label>
            <input type="text" id="rest_api_name_test" name="rest_api_name_test" style="width: 300px;">
                    <button type="submit" class="button_submit">  Test  </button>
            <br>
    <textarea id =ta_test_peptides rows = "12" cols = "200" name = "description">
[
  {
    "peptide": "AAAAEEAAA"
  },
  {
    "peptide": "EEEEEE"
  },
    {
    "peptide": "EEEEIII"
  }
]
    </textarea><br>
            </form>
        <textarea id =ta_result_peptides rows = "12" cols = "200" name = "description">

    </textarea><br>
    <p id="p_elapsed_time"></p>
</div>

<script>
function openTab(evt, cityName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}
// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();
</script>
<script>
$(document).ready(function() {
        $.ajax({
           type: "GET",
           url: "/load_list_models",
           data: "{}",
           dataType: "json",
           success: function (data) {
               var s = '<option value="-1">Please Select a Model</option>';
               for (var i = 0; i < data.length; i++) {
                   s += '<option value="' + i + '">' + data[i] + '</option>';
               }
               $("#modelsDropdown").html(s);
           }

       });
    $('#loadingDiv_search_files').hide()
    $('#loadingDiv_train').hide()
    $('#trainingDiv').hide()

    $('#tb-ions').DataTable( {
        autoFill: true,
        filter: false,
        paging: false,
        columnDefs: [{
    "defaultContent": "-",
    "targets": "_all"
  }],
        info: false,
        select: {
            style: 'multi'
        }
    } );

     $('#tb-ions').hide(); // TODO: Implement this

     $('#tb-models').DataTable( {
        autoFill: true,
        filter: false,
        paging: false,
        info: false,
        select: {
            style: 'multi'
        }
    } );
} );
  Table = $("#example").DataTable({
    data:[],
        columns: [
            { "data": "id" },
            { "data": "Fragmentation" },
            { "data": "Charge" },
            { "data": "NumberPeptides" }
        ],
        rowCallback: function(row, data, index){
            console.log(data['NumberPeptides']);
  	        if(data['NumberPeptides']< 100){
    	        $(row).find('td:eq(3)').css('color', 'red');
            }
    },
    filter: false,
    info: false,
    ordering: true,
    processing: true,
    retrieve: true,
    paging: false,
    select: {
            style: 'single'
        }
    });

  $('#tb-ions tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {

            $(this).addClass('selected');
        }
    } );
    $('#tb-models tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            $(this).addClass('selected');
        }
    } );
    $('#example tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            Table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    } );

    $('#button').click( function () {
        Table.row('.selected').remove().draw( false );
    } );
</script>
<script>
    $(document).ready(function() {
     $('#search_folder').on('submit', function(event) {
       $('#loadingDiv_search_files').show();
       $.ajax({
          data : {
                    local_path : $('#pathroot').val(),
                    andromeda_score: $('#andromedascore').val(),
                 },
          type : 'POST',
          url : '/select_folder_training',
          dataType: "json",
          success: function(result){
                $('#loadingDiv_search_files').hide();
                $('#trainingDiv').show();
                Table.clear().draw();
                Table.rows.add(result).draw();
          },
          failure: function(errMsg) {
                console.log(errMsg);
         }
      });
      event.preventDefault();
      });

     $("#modelsDropdown").change(function() {
        document.getElementById('img_msms').src = '';
        document.getElementById('img_rt').src = '';
                model_name=$(this).find("option:selected").text();
        $.ajax({
          data : {
                    model : model_name,
                 },
          type : 'POST',
          url : '/get_image_rt',
          dataType: "json",

          success: function(result){
                document.getElementById('img_rt').src = 'data:;base64,' + result['image'];
          },
          failure: function(errMsg) {
                console.log(errMsg);
            }
        });

        $.ajax({
          data : {
                    model : model_name,
                 },
          type : 'POST',
          url : '/get_image_msms',
          dataType: "json",

          success: function(result){
                document.getElementById('img_msms').src = 'data:;base64,' + result['image'];
          },
          failure: function(errMsg) {
                console.log(errMsg);
            }
        });
      });

      $('#form_list_models').on('submit', function(event) {

       var model_name = $('#modelsDropdown :selected').text();
       $.ajax({
          data : {
                    model : model_name,
                 },
          type : 'POST',
          url : '/get_model_info',
          dataType: "json",
          success: function(result){


            var chart = c3.generate({
                bindto: '#chart_rt_realVSpred',
                data: {
                    json: result,
                    keys: {
                        x: 'real',
                        value: ['predicted'],
                },
                type: 'scatter'
                },
                title: {
                    text: 'Retention Time'
                },
                tooltip: {
                    show: false
                },
                axis: {
                        x: {
                        tick: {
                            fit: false,

                        },
                        y: {
                            label: {
                            text: 'Y Axis Label Something Else Blah! Blah! Blah!',

                            }
                        }
            }
    }
            });


          },
          failure: function(errMsg) {
                console.log(errMsg);
         }
      });
      event.preventDefault();
      });




$('#form_test_service').on('submit', function(event) {
       var model_name = $('#rest_api_name_test').val();
       var peptides = JSON.parse($('#ta_test_peptides').val());
       const myArr = JSON.parse($('#ta_test_peptides').val());
       console.log(myArr);
       $.ajax({
          data: JSON.stringify(myArr),
          type : 'POST',
          dataType: 'json',
          url : model_name,
          contentType: "application/json",
          start_time: new Date().getTime(),
          success: function(result){
                $("#ta_result_peptides").val(JSON.stringify(result,null,2));
          },
          failure: function(errMsg) {
                $("#ta_result_peptides").val(errMsg);
          },
          complete: function(data) {
            $("#p_elapsed_time").text('This request took '+(new Date().getTime() - this.start_time)+' ms');
          }
      });
      event.preventDefault();
      });

});



</script>
<script>
function train() {

    var dir = document.getElementById("pathroot").value;
    var api_name = document.getElementById("rest_api_name").value;
    var andromeda_score = document.getElementById("andromedascore").value;
    var oData = Table.rows('.selected').data();
    var frag= oData[0]['Fragmentation'];
    var charge =oData[0]['Charge'];
    var msms_flag = 0;
    var rt_flag = 0;

    var selected_models = [];

    if (document.getElementById('cb_msms').checked){
        msms_flag=1
    }
     if (document.getElementById('cb_rt').checked){
        rt_flag=1
    }

    $('#loadingDiv_train').show();
    $.ajax({
          data : {
                    local_path : dir,
                    andromeda_score: andromeda_score,
                    fragmentation :frag,
                    charge: charge,
                    rest_api_nam : api_name,
                    msms:msms_flag,
                    rt:rt_flag
                 },
          type : 'POST',
          url : '/train_unique',
          dataType: "json",
          success: function(result){
                $('#loadingDiv_train').hide();

                loadModels();

          },
          failure: function(errMsg) {
                console.log(errMsg);
         }
      });
}
function loadModels()
{
 $.ajax({
           type: "GET",
           url: "/load_list_models",
           data: "{}",
           dataType: "json",
           success: function (data) {

               var s = '<option value="-1">Please Select a Model</option>';
               for (var i = 0; i < data.length; i++) {
                   s += '<option value="' + i + '">' + data[i] + '</option>';
               }
               $("#modelsDropdown").html(s);
           }

});}
</script>
<script>


</script>
<div id="id"></div>
<h3>© 2020-2021 Max-Planck-Institut für Biochemie. All rights reserved.</h3>
<h3>Contact: salinas@biochem.mpg.de</h3>
</body>
</html>
